# build readme first

- use: :make readme

- id: siteMeta
  use: fsExtra.readJSONFile
  args: ./pkg.json

- id: readmeContent
  use: Deno.readTextFile
  args: ./README.md

- id: markdownHTML
  from: "https://deno.land/x/gfm@0.1.22/mod.ts"
  use: render
  args:
    - $readmeContent

- from: "https://deno.land/x/gfm@0.1.22/mod.ts"
  use: import
  args:
    - CSS
- from: https://esm.sh/prismjs@1.27.0/components/prism-typescript?no-check
  use: false
- from: https://esm.sh/prismjs@1.27.0/components/prism-yaml?no-check
  use: false

- id: makeSiteSource
  use: Deno.readTextFile
  args: ./docs/make_site.ys.yml
- id: makeSiteHTML
  from: https://esm.sh/prismjs@1.27.0
  use: default.highlight
  args:
    - $makeSiteSource
    - $Prism.languages.yaml
    - yaml
- id: siteSource
  use: Deno.readTextFile
  args: ./docs/site.ys.yml
- id: siteHTML
  from: https://esm.sh/prismjs@1.27.0
  use: default.highlight
  args:
    - $siteSource
    - $Prism.languages.yaml
    - yaml
- id: githubActionsSource
  use: Deno.readTextFile
  args: ./.github/workflows/deploy-to-deno-deploy.yml
- id: githubActionsSourceHTML
  from: https://esm.sh/prismjs@1.27.0
  use: default.highlight
  args:
    - $githubActionsSource
    - $Prism.languages.yaml
    - yaml
# get readme.tmpl.html content
- id: indexTemplate
  use: Deno.readTextFile
  args: ./docs/index.tmpl.html

# use mustache to render readme.template.md
- id: indexHTML
  from: https://esm.sh/mustache@4.2.0
  use: default.render
  args:
    - $indexTemplate
    - siteMeta: $siteMeta
      CSS: $CSS
      markdownHTML: $markdownHTML
      makeSiteHTML: $makeSiteHTML
      siteHTML: $siteHTML
      githubActionsSourceHTML: $githubActionsSourceHTML

# write to public/index.html
- use: fsExtra.ensureAndWriteTextFile
  args:
    - public/index.html
    - $indexHTML

# build den deploy code

- use: :YAMLSCRIPT_DEV=1 deno run -A ys.ts build ./docs/site.ys.yml

- if: build.env.YAMLSCRIPT_SERVE == "1"
  use: :deno run -A ./dist/docs/site.js
